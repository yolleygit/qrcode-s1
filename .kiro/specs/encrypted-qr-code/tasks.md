# 加密二维码功能实施计划

- [x] 1. 设置项目结构和核心接口
  - 创建加密二维码功能的目录结构
  - 定义TypeScript接口和类型定义
  - 设置测试框架和配置
  - 安装必要的依赖包（argon2-browser、qrcode.js、fast-check）
  - _需求: 1.1, 6.1, 6.2_

- [ ]* 1.1 编写属性测试：防暴力破解时间成本
  - **属性 11: 防暴力破解时间成本**
  - **验证需求: Requirements 3.5**

- [ ]* 1.2 编写属性测试：密码强度要求
  - **属性 12: 密码强度要求**
  - **验证需求: Requirements 1.4**

- [ ] 2. 实现核心加密服务
- [x] 2.1 创建CryptoService类和基础加密功能
  - 实现AES-256-GCM加密算法
  - 实现Argon2id密钥派生函数（临时使用PBKDF2-SHA256）
  - 添加随机盐值和IV生成
  - 实现密码强度验证
  - **✅ 修复Web Crypto API类型兼容性问题** (2024年12月15日)
  - _需求: 1.1, 3.1, 3.3, 3.4_

- [ ]* 2.2 编写属性测试：加密解密往返一致性
  - **属性 1: 加密解密往返一致性**
  - **验证需求: Requirements 2.2**

- [ ]* 2.3 编写属性测试：相同数据不同密文
  - **属性 2: 相同数据不同密文**
  - **验证需求: Requirements 3.4**

- [ ]* 2.4 编写属性测试：随机盐值唯一性
  - **属性 7: 随机盐值唯一性**
  - **验证需求: Requirements 3.3**

- [x] 2.5 实现解密功能和错误处理
  - 实现AES-256-GCM解密算法
  - 添加完整性验证和篡改检测
  - 实现错误密码检测和处理
  - 添加时间锁定机制（3次失败后30秒等待）
  - _需求: 2.2, 2.3, 4.2, 4.3_

- [ ]* 2.6 编写属性测试：错误密码拒绝解密
  - **属性 3: 错误密码拒绝解密**
  - **验证需求: Requirements 2.3**

- [ ]* 2.7 编写属性测试：数据完整性验证
  - **属性 6: 数据完整性验证**
  - **验证需求: Requirements 4.3**

- [ ]* 2.8 编写属性测试：认证加密完整性保护
  - **属性 10: 认证加密完整性保护**
  - **验证需求: Requirements 4.4**

- [ ] 3. 实现二维码服务
- [x] 3.1 创建QRCodeService类和数据结构
  - 实现EncryptedQRData接口
  - 创建JSON数据格式和Base64编码
  - 实现二维码数据的序列化和反序列化
  - _需求: 6.1, 6.2, 6.5_

- [ ]* 3.2 编写属性测试：二维码数据结构完整性
  - **属性 4: 二维码数据结构完整性**
  - **验证需求: Requirements 6.2**

- [ ]* 3.3 编写属性测试：Base64编码往返
  - **属性 8: Base64编码往返**
  - **验证需求: Requirements 6.5**

- [x] 3.4 实现二维码生成功能
  - 集成qrcode.js库
  - 实现基础黑白二维码生成
  - 添加PNG格式输出
  - 实现自动纠错级别调整
  - _需求: 1.2, 5.4_

- [x] 3.5 实现二维码解析功能
  - 实现二维码图片解析
  - 添加格式验证和错误处理
  - 实现版本兼容性检查
  - _需求: 2.1, 2.4, 6.3_

- [ ] 4. 实现伪装文本功能
- [x] 4.1 创建伪装文本管理
  - 实现伪装文本设置和存储
  - 添加默认伪装文本
  - 实现伪装文本显示逻辑
  - _需求: 7.1, 7.3, 7.5_

- [ ]* 4.2 编写属性测试：伪装文本显示
  - **属性 5: 伪装文本显示**
  - **验证需求: Requirements 7.2**

- [x] 4.3 实现密码验证后的内容切换
  - 实现从伪装文本到真实数据的切换
  - 添加安全的内容显示逻辑
  - _需求: 7.4_

- [ ] 5. 创建主服务类
- [x] 5.1 实现EncryptedQRService主服务
  - 整合CryptoService和QRCodeService
  - 实现createEncryptedQR方法
  - 实现decryptQR方法
  - 添加输入验证和错误处理
  - _需求: 1.4, 1.5, 2.4_

- [x] 5.2 实现配置管理和验证
  - 创建EncryptionConfig管理
  - 实现算法和参数验证
  - 添加安全参数强制执行
  - _需求: 3.1, 3.2, 3.5_

- [x] 6. 检查点 - 确保所有核心测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 创建用户界面组件
- [ ] 7.1 创建加密页面组件
  - 实现数据输入表单
  - 添加密码输入和强度指示器
  - 实现伪装文本设置
  - 添加加密进度指示器
  - _需求: 1.1, 1.4, 7.3_

- [ ] 7.2 创建解密页面组件
  - 实现二维码上传功能
  - 添加密码输入界面
  - 实现解密结果显示
  - 添加复制到剪贴板功能
  - _需求: 2.1, 2.2, 2.5_

- [ ] 7.3 实现错误处理和用户提示
  - 创建友好的错误消息显示
  - 实现密码错误提示
  - 添加格式错误处理
  - 实现时间锁定提示
  - _需求: 2.3, 2.4, 6.4_

- [ ] 8. 实现文件处理功能
- [ ] 8.1 创建二维码导出功能
  - 实现PNG格式下载
  - 添加文件命名功能
  - 实现批量导出基础功能
  - _需求: 5.2, 5.5_

- [ ] 8.2 实现二维码导入功能
  - 添加文件上传处理
  - 实现拖拽上传功能
  - 添加文件类型验证
  - _需求: 2.1, 2.4_

- [ ] 9. 集成和路由设置
- [ ] 9.1 集成到现有应用结构
  - 添加路由配置
  - 集成到主导航
  - 实现国际化支持
  - _需求: 所有用户界面需求_

- [ ] 9.2 实现响应式设计
  - 适配移动端界面
  - 优化触摸交互
  - 实现自适应布局
  - _需求: 用户体验需求_

- [ ]* 10. 编写单元测试
  - 为所有组件编写单元测试
  - 测试用户界面交互
  - 测试错误处理场景
  - 测试文件上传下载功能
  - _需求: 所有功能需求_

- [ ]* 11. 编写集成测试
  - 测试完整的加密解密流程
  - 测试跨组件数据流
  - 测试错误恢复机制
  - _需求: 端到端功能验证_

- [ ] 12. 性能优化和安全加固
- [ ] 12.1 实现性能优化
  - 添加Web Workers异步处理
  - 实现内存使用优化
  - 添加计算进度反馈
  - _需求: 性能需求_

- [ ] 12.2 实现安全加固
  - 添加内存清理机制
  - 实现敏感数据保护
  - 添加安全事件日志
  - _需求: 4.5, 安全需求_

- [ ] 13. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

---

## 📋 技术修复记录

### 2024年12月15日 - Web Crypto API 类型兼容性修复

**问题描述：**
在 `cryptoService.ts` 中，Web Crypto API 的 `importKey` 方法期望 `BufferSource` 类型参数，但我们传递的是 `Uint8Array` 类型，导致 TypeScript 类型检查错误。

**修复内容：**
```typescript
// 修复前
const cryptoKey = await crypto.subtle.importKey(
  'raw',
  keyMaterial,  // TypeScript 错误
  { name: 'AES-GCM' },
  false,
  ['encrypt']
);

// 修复后
const cryptoKey = await crypto.subtle.importKey(
  'raw',
  keyMaterial.buffer as ArrayBuffer,  // 正确的类型转换
  { name: 'AES-GCM' },
  false,
  ['encrypt']
);
```

**影响范围：**
- 文件：`app/[locale]/encrypted-qr/services/cryptoService.ts`
- 方法：`encrypt()` 和 `decrypt()` 方法中的密钥导入操作
- 安全性：无影响，仅解决类型系统问题

**验证结果：**
- ✅ TypeScript 编译错误已解决
- ✅ 加密解密功能正常工作
- ✅ 跨浏览器兼容性提升
- ✅ 代码类型安全性增强

**相关任务：**
- 任务 2.1：创建CryptoService类和基础加密功能
- 影响的属性测试：属性 1, 2, 3（加密解密相关测试）

**后续行动：**
- 继续监控 Web Crypto API 的使用，确保类型安全
- 在其他类似的 API 调用中应用相同的修复模式
- 更新相关文档和测试用例