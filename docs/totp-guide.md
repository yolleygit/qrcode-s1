# TOTP 动态验证码使用指南

## 简介

TOTP（Time-based One-Time Password）动态验证码功能为 QR Master 提供双因素认证二维码生成能力。用户可以创建与 Google Authenticator、Microsoft Authenticator 等主流认证应用兼容的动态验证码二维码。

## 开发状态

**当前版本：** 开发中 (MVP 阶段)  
**预计发布：** 2025年第一季度  
**完成进度：** 基础结构已完成，核心算法开发中

### ✅ 已完成功能
- 项目基础结构搭建
- TypeScript 类型定义和接口
- 依赖包安装和配置
- **TOTP 核心算法实现** - 完整的 RFC 6238 标准实现
- **密钥生成和 Base32 编码** - 安全的随机密钥生成和编码解码
- **OTPAuth URI 生成** - 符合 Google Authenticator 标准的 URI 格式
- **用户界面组件** - 完整的配置表单和二维码显示界面
- **定时器服务** - 30秒倒计时和自动验证码更新
- **二维码生成和显示** - 集成 qr-code-styling 的高质量二维码

### 🔧 开发中功能
- **核心功能实现** - 基于 otplib 的真实 TOTP 验证码生成 (进行中)
- **二维码渲染** - 使用 qrcode 库生成真实的二维码图片 (进行中)
- **定时刷新机制** - 验证码每30秒自动更新 (计划中)
- **手动刷新功能** - 用户可手动刷新验证码 (计划中)
- 兼容性测试（Google Authenticator 等应用）
- 性能优化和错误处理
- 移动端体验优化

### 📋 计划功能
- 高级配置选项（多种算法、时间窗口）
- 验证码校验功能
- 配置本地存储和管理
- 批量导出功能

## 功能特性

### 核心功能
- **标准兼容**：完全符合 RFC 6238 TOTP 标准
- **应用兼容**：支持 Google Authenticator、Microsoft Authenticator 等主流应用
- **实时更新**：验证码每 30 秒自动更新
- **安全可靠**：本地生成，不上传任何敏感信息

### 高级功能（计划中）
- **多种算法**：支持 SHA-1、SHA-256、SHA-512 哈希算法
- **灵活配置**：可调节验证码长度（6位/8位）和时间窗口（15/30/60秒）
- **验证功能**：内置验证码校验功能
- **配置管理**：保存、导出、导入 TOTP 配置

## 使用场景

### 个人用户
- **社交账户**：为 GitHub、Google、Facebook 等账户设置双因素认证
- **金融服务**：为银行、支付应用等敏感账户增加安全保护
- **工作账户**：为企业邮箱、云服务等工作相关账户启用 2FA

### 企业用户
- **员工账户**：为企业内部系统批量生成 TOTP 配置
- **客户服务**：为客户提供安全的双因素认证设置
- **系统集成**：将 TOTP 功能集成到现有安全体系中

### 开发者
- **应用开发**：为自己的应用添加双因素认证功能
- **测试验证**：生成测试用的 TOTP 配置
- **安全研究**：学习和研究 TOTP 算法实现

## 安全考虑

### 密钥安全
- **本地生成**：所有密钥在用户设备本地生成
- **安全随机**：使用加密安全的随机数生成器
- **不上传**：密钥和配置信息不会上传到服务器
- **用户控制**：用户完全控制密钥的存储和使用

### 时间同步
- **时间准确性**：TOTP 依赖准确的系统时间
- **同步检测**：提供时间同步状态检查功能
- **偏差处理**：支持一定范围内的时间偏差容错

### 使用建议
- **安全存储**：妥善保管生成的密钥和二维码
- **备份恢复**：建议保存配置信息以便设备更换时恢复
- **定期检查**：定期验证 TOTP 配置的有效性

## 开发进展

### 已完成里程碑

#### 🏗️ 基础结构搭建 (已完成)
- ✅ 安装 crypto-js 依赖包
- ✅ 创建 `/totp` 路由目录结构
- ✅ 定义 TypeScript 接口和类型
- ✅ 配置项目构建和开发环境

### 当前开发任务

#### ✅ 核心算法实现 (已完成)
- ✅ TOTP 算法核心逻辑（RFC 6238 标准）
- ✅ Base32 编码/解码功能
- ✅ OTPAuth URI 生成
- ✅ 密钥生成和管理

#### ✅ 用户界面开发 (已完成)
- ✅ 服务名称和账户输入表单
- ✅ 二维码显示组件（集成 qr-code-styling）
- ✅ 验证码显示和倒计时
- ✅ 复制和下载功能

#### 🔧 测试和优化 (进行中)
- 🔄 功能完整性测试
- 🔄 Google Authenticator 兼容性验证
- 🔄 移动端体验优化
- 🔄 错误处理和边界情况

### 下一步计划

1. **功能测试**：验证与主流认证应用的兼容性 ✅ **进行中**
2. **性能优化**：优化定时器和内存使用
3. **错误处理**：完善异常情况的处理逻辑
4. **高级功能**：添加多种算法和时间窗口支持
5. **配置管理**：实现配置的本地存储和管理

## 技术实现

### 架构设计
```
TOTP 模块架构
├── 核心服务 (Core Services)
│   ├── TOTP 算法服务
│   ├── 密钥管理服务
│   └── 定时器服务
├── 用户界面 (UI Components)
│   ├── 配置表单组件
│   ├── 二维码显示组件
│   └── 验证码显示组件
└── 工具模块 (Utilities)
    ├── Base32 编码工具
    ├── URI 生成工具
    └── 时间同步工具
```

### 技术栈
- **前端框架**：React 18 + TypeScript
- **TOTP 算法库**：otplib - 符合 RFC 6238 标准的 TOTP 实现
- **二维码生成**：qrcode - 高性能二维码生成库
- **加密库**：crypto-js（备用）
- **状态管理**：React Hooks (useState, useEffect, useRef, useCallback)
- **样式系统**：Tailwind CSS（复用现有）
- **图标库**：Lucide React（包含 RefreshCw 等新图标）

### 最新技术更新 (2024年12月16日)
**核心依赖升级**：
- ✅ **otplib** - 专业的 TOTP/HOTP 算法库，替代自研实现
- ✅ **qrcode** - 轻量级二维码生成库，支持多种输出格式
- ✅ **React Hooks 扩展** - 新增 useEffect 和 useRef 支持定时器和 DOM 操作
- ✅ **图标组件扩展** - 新增 RefreshCw 图标支持手动刷新功能

**技术优势**：
- 🔒 **标准合规** - otplib 完全符合 RFC 6238 和 RFC 4226 标准
- ⚡ **性能优化** - qrcode 库提供高效的二维码生成性能
- 🛠️ **开发友好** - 成熟的库减少自研风险，提升开发效率
- 🔄 **实时更新** - 支持验证码定时刷新和手动刷新功能

### 标准兼容
- **RFC 6238**：TOTP 算法标准
- **RFC 4648**：Base32 编码标准
- **Google Authenticator**：URI 格式标准

## 参与开发

### 开发者指南
如果您想参与 TOTP 功能的开发，可以：

1. **查看任务列表**：参考 `.kiro/specs/animated-qr-code/tasks.md`
2. **了解设计文档**：阅读 `.kiro/specs/animated-qr-code/design.md`
3. **理解需求规格**：查看 `.kiro/specs/animated-qr-code/requirements.md`

### 测试和反馈
- **功能测试**：测试生成的二维码与认证应用的兼容性
- **用户体验**：提供界面和交互的改进建议
- **安全审查**：协助进行安全性评估和改进

### 贡献方式
- **代码贡献**：参与核心功能的开发实现
- **文档完善**：改进用户指南和技术文档
- **测试验证**：帮助测试功能的正确性和兼容性
- **反馈建议**：提供功能改进和优化建议

## 常见问题

### Q: TOTP 功能什么时候可以使用？
A: MVP 版本已基本完成开发，正在进行最后的测试和优化，预计很快就能发布基础功能。

### Q: 会支持哪些认证应用？
A: 将支持所有符合 TOTP 标准的认证应用，包括 Google Authenticator、Microsoft Authenticator、Authy 等。

### Q: 生成的密钥是否安全？
A: 是的，所有密钥都在用户设备本地生成，使用加密安全的随机数生成器，不会上传到服务器。

### Q: 如何确保时间同步？
A: 系统会提供时间同步检查功能，并支持一定范围内的时间偏差容错。

### Q: 是否支持自定义参数？
A: MVP 版本将支持基础的 TOTP 功能（SHA-1、6位、30秒），后续版本会添加更多自定义选项。

---

*最后更新：2024年12月 | 下次更新：核心算法完成后*